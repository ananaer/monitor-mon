(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const c of n)if(c.type==="childList")for(const i of c.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const c={};return n.integrity&&(c.integrity=n.integrity),n.referrerPolicy&&(c.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?c.credentials="include":n.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(n){if(n.ep)return;n.ep=!0;const c=o(n);fetch(n.href,c)}})();const S="https://joisixcdkdihqduxllzn.supabase.co",N="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpvaXNpeGNka2RpaHFkdXhsbHpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODM2NjYsImV4cCI6MjA4NzA1OTY2Nn0.3v-G_lTJOnex0am3BLMgGA97_ZZ3tg9j8tXdDsN2H-U",B=`${S}/functions/v1`,I={Authorization:`Bearer ${N}`,"Content-Type":"application/json"};async function g(t,e=12e3){const o=new AbortController,r=setTimeout(()=>o.abort(),e);try{const n=await fetch(`${B}${t}`,{headers:I,cache:"no-store",signal:o.signal});if(!n.ok)throw new Error(`请求失败 ${n.status}: ${t}`);return await n.json()}finally{clearTimeout(r)}}function A(){return g("/api-overview")}function L(t=120){return g(`/api-history?limit=${t}`)}function k(t=50){return g(`/api-alerts?limit=${t}`)}function T(){return g("/collect-mon")}function a(t,e=2){return t==null||Number.isNaN(t)?"-":Number(t).toLocaleString("zh-CN",{maximumFractionDigits:e,minimumFractionDigits:e>0?Math.min(e,2):0})}function M(t){return t==null||Number.isNaN(t)?"-":`${t>0?"+":""}${Number(t).toFixed(2)}%`}function x(t){if(!t)return"-";const e=new Date(t);return Number.isNaN(e.getTime())?t:e.toLocaleString("zh-CN",{hour12:!1})}function w(t){if(!t)return null;const e=new Date(t);return Number.isNaN(e.getTime())?null:Math.max(0,Math.floor((Date.now()-e.getTime())/1e3))}function O(t){return t==null?"":t>0?"up":t<0?"down":""}function D(t){return t==null?"ratio-neutral":t>=1?"ratio-good":t>=.7?"ratio-mid":"ratio-bad"}function l(t){return String(t??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}const s={tokenName:document.getElementById("token-name"),dbPath:document.getElementById("db-path"),updatedAt:document.getElementById("updated-at"),collectorStatusText:document.getElementById("collector-status-text"),collectorStatusExtra:document.getElementById("collector-status-extra"),collectorError:document.getElementById("collector-error"),refreshBtn:document.getElementById("refresh-btn"),collectBtn:document.getElementById("collect-btn"),refreshHint:document.getElementById("refresh-hint"),refreshStatus:document.getElementById("refresh-status"),errorBox:document.getElementById("error-box"),kpiVenueCount:document.getElementById("kpi-venue-count"),kpiOnlineCount:document.getElementById("kpi-online-count"),kpiAlerts24h:document.getElementById("kpi-alerts-24h"),kpiCritical24h:document.getElementById("kpi-critical-24h"),kpiAvgSpread:document.getElementById("kpi-avg-spread"),kpiTotalDepth:document.getElementById("kpi-total-depth"),venueTbody:document.getElementById("venue-tbody"),trendSummary:document.getElementById("trend-summary"),alertCount:document.getElementById("alert-count"),alertEmpty:document.getElementById("alert-empty"),alertList:document.getElementById("alert-list")};function b(){return s}function $(t){s.refreshBtn.disabled=t,s.refreshBtn.textContent=t?"刷新中...":"立即刷新"}function p(t,e){s.refreshStatus.textContent=`状态：${t}`,s.refreshStatus.className=`refresh-status ${e||"status-running"}`}function _(t){if(!t){s.errorBox.classList.add("hidden"),s.errorBox.textContent="";return}s.errorBox.textContent=t,s.errorBox.classList.remove("hidden")}function H(t){if(!t){s.collectorStatusText.textContent="未知",s.collectorStatusText.className="collector-stopped",s.collectorStatusExtra.textContent="",s.collectorError.classList.add("hidden");return}const e=t.service_status||"unknown",o={running:"运行中",degraded:"异常恢复中",stale:"数据陈旧",stopped:"已停止"},r={running:"collector-ok",degraded:"collector-degraded",stale:"collector-stale",stopped:"collector-stopped"};s.collectorStatusText.textContent=o[e]??"未知",s.collectorStatusText.className=r[e]??"collector-stopped";const n=t.last_success_age_seconds;let c=typeof n=="number"?`（上次成功 ${n}s 前）`:"";s.collectorStatusExtra.textContent=c,s.collectorError.classList.add("hidden")}function R(t){const e=t.venues||[],o=t.stats||{},r=e.filter(u=>u.status==="ok").length,n=e.map(u=>u.spread_bps).filter(u=>typeof u=="number"),c=n.length>0?n.reduce((u,y)=>u+y,0)/n.length:null,i=e.reduce((u,y)=>u+(Number(y.depth_1pct_total_usdt)||0),0);s.kpiVenueCount.textContent=String(o.venue_count??e.length??0),s.kpiOnlineCount.textContent=String(r),s.kpiAlerts24h.textContent=String(o.alerts_24h??0),s.kpiCritical24h.textContent=String(o.critical_alerts_24h??0),s.kpiAvgSpread.textContent=a(c,2),s.kpiTotalDepth.textContent=`$${a(i,0)}`}function F(t,e,o){const r=w(e),n=Number(o);return t==="ok"?r===null?"状态正常":r<=2?"刚刚更新":`${r}s 前更新`:t==="stale"?Number.isFinite(n)&&n>=0?`数据 ${n}s 未更新`:"数据陈旧":r!==null?`上次成功 ${r}s 前`:"暂无成功样本"}function j(t){const o=(t.venues||[]).map(r=>{const n=r?.ratios?.depth_vs_baseline;return`
    <tr>
      <td>
        <strong>${l((r.venue||"-").toUpperCase())}</strong>
        <p class="tiny">${l(r.symbol||"-")}</p>
      </td>
      <td>
        <span class="status-tag status-${l(r.status||"down")}">
          ${l(r.status||"down")}
        </span>
        <p class="tiny">${l(F(r.status,r.last_success_ts_utc||r.snapshot_ts_utc,r.snapshot_age_seconds))}</p>
        ${r.error_reason&&r.status!=="ok"?`<p class="tiny">${l(r.error_reason)}</p>`:""}
      </td>
      <td>${l(a(r.last_price,6))}</td>
      <td class="${l(O(r.pct_change_1h))}">${l(M(r.pct_change_1h))}</td>
      <td>$${l(a(r.quote_volume_24h,0))}</td>
      <td>${l(a(r.spread_bps,2))}</td>
      <td>$${l(a(r.depth_1pct_total_usdt,0))}</td>
      <td>${l(a(r.slip_bps_n2,2))}</td>
      <td>
        <span class="${l(D(n))}">
          ${l(n==null?"-":`${Number(n).toFixed(2)}x`)}
        </span>
      </td>
    </tr>`}).join("");s.venueTbody.innerHTML=o||'<tr><td colspan="9">暂无数据</td></tr>'}function z(t){const e=t?.items||[];if(s.alertCount.textContent=`最近 ${e.length} 条`,e.length===0){s.alertEmpty.classList.remove("hidden"),s.alertList.classList.add("hidden"),s.alertList.innerHTML="";return}s.alertEmpty.classList.add("hidden"),s.alertList.classList.remove("hidden"),s.alertList.innerHTML=e.map(o=>`
    <li class="alert-item">
      <div>
        <span class="severity-tag sev-${l(o.severity||"info")}">${l(o.severity||"info")}</span>
        <strong>${l(o.alert_type||"-")}</strong>
        <span class="muted">${l((o.venue||"-").toUpperCase())}</span>
      </div>
      <p>${l(o.message||"-")}</p>
      <p class="tiny">${l(x(o.ts_utc))}</p>
    </li>`).join("")}function V(t){const e=t?.by_venue||{},o=Object.keys(e);if(o.length===0){s.trendSummary.textContent="暂无趋势数据";return}const r=o.map(n=>{const c=e[n]||[],i=c.length>0?c[c.length-1]:null;return`${n.toUpperCase()}  价格: ${a(i?.last_price,6)}  价差: ${a(i?.spread_bps,2)} bps  深度: $${a(i?.depth_1pct_total_usdt,0)}`});s.trendSummary.textContent=r.join(`
`)}function J(t){s.tokenName.textContent=t.token_hint||"TOKEN",s.dbPath.textContent=t.db_path||"-",s.updatedAt.textContent=x(t.updated_at_utc),H(t.collector),R(t),j(t)}function E(t,e){const o=Math.max(0,t-Date.now()),r=Math.ceil(o/1e3),n=Math.ceil(e/1e3);s.refreshHint.textContent=`自动刷新倒计时：${r}s（周期 ${n}s）`}const C=15e3,P=5e3,U=3e4;let f=!1,m=C,d=Date.now()+C;async function h(t="auto"){if(!f){f=!0,$(!0),p("刷新中","status-loading");try{const[e,o,r]=await Promise.all([A(),L(120),k(50)]);J(e),V(o),z(r),_(""),d=Date.now()+m,E(d,m);const n=new Date().toLocaleTimeString("zh-CN",{hour12:!1});p(t==="manual"?`手动刷新成功 ${n}`:`自动刷新成功 ${n}`,"status-success");const c=e?.collector?.schedule_seconds;if(typeof c=="number"){const i=Math.floor(c*1e3/2);m=Math.max(P,Math.min(U,i))}}catch(e){_(e?.message||String(e)),p("刷新失败","status-error")}finally{f=!1,$(!1)}}}async function X(){const t=b();if(t.collectBtn){t.collectBtn.disabled=!0,t.collectBtn.textContent="采集中...";try{await T(),await h("manual")}catch(e){_(e?.message||String(e))}finally{t.collectBtn.disabled=!1,t.collectBtn.textContent="立即采集"}}}function Y(){const t=b();t.refreshBtn.addEventListener("click",()=>h("manual")),t.collectBtn&&t.collectBtn.addEventListener("click",X),d=Date.now()+m,E(d,m),p("运行中","status-running"),h("init"),setInterval(()=>{E(d,m),!f&&Date.now()>=d&&h("auto")},1e3)}Y();
