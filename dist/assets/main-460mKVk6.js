import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */import{e as a,f as se,a as G,g as ce,b as le,c as re,d as ie,h as ae,s as de}from"./format-DR5tjaKg.js";const ge={binance:"#f0b90b",okx:"#1677ff",bybit:"#ff6b35"},U="#0e7490";function ue(e){return ge[e?.toLowerCase()]??U}function pe(e,n,o,t={}){const c=window.devicePixelRatio||1,l=e.offsetWidth||300,g=e.offsetHeight||80;e.width=l*c,e.height=g*c;const s=e.getContext("2d");s.scale(c,c),s.clearRect(0,0,l,g);const r=n.map(f=>Number(f[o])).filter(f=>Number.isFinite(f));if(r.length<2){s.fillStyle="#94a3b8",s.font="11px sans-serif",s.textAlign="center",s.fillText("数据不足",l/2,g/2);return}const u=4,d=8,b=18,C=l-u*2,m=g-d-b;let p=Math.min(...r),h=Math.max(...r);const k=h-p||Math.abs(p)*.01||1;p-=k*.05,h+=k*.05;const w=h-p,I=f=>u+f/(r.length-1)*C,B=f=>d+(1-(f-p)/w)*m,x=t.color||U,N=s.createLinearGradient(0,d,0,d+m);N.addColorStop(0,x+"40"),N.addColorStop(1,x+"00"),s.beginPath(),s.moveTo(I(0),B(r[0]));for(let f=1;f<r.length;f++)s.lineTo(I(f),B(r[f]));s.lineTo(I(r.length-1),d+m),s.lineTo(I(0),d+m),s.closePath(),s.fillStyle=N,s.fill(),s.beginPath(),s.moveTo(I(0),B(r[0]));for(let f=1;f<r.length;f++)s.lineTo(I(f),B(r[f]));s.strokeStyle=x,s.lineWidth=1.5,s.lineJoin="round",s.stroke();const ne=I(r.length-1),oe=B(r[r.length-1]);s.beginPath(),s.arc(ne,oe,3,0,Math.PI*2),s.fillStyle=x,s.fill();const O=t.format||(f=>f.toFixed(2));s.fillStyle="#64748b",s.font="10px sans-serif",s.textAlign="left",s.fillText(O(p+k*.05),u,g-4),s.textAlign="right",s.fillText(O(h-k*.05),l-u,g-4)}function Y(e){const n=e?.by_venue||{},o=Object.keys(n),t=document.getElementById("trend-charts");if(!t)return;if(t.innerHTML="",o.length===0){t.innerHTML='<p class="muted">暂无趋势数据</p>';return}[{key:"last_price",label:"价格",format:l=>l.toFixed(6)},{key:"spread_bps",label:"价差 (bps)",format:l=>l.toFixed(2)},{key:"depth_1pct_total_usdt",label:"1% 深度 (USDT)",format:l=>"$"+(l>=1e3?(l/1e3).toFixed(1)+"k":l.toFixed(0))},{key:"open_interest_usd",label:"持仓量 OI (USDT)",format:l=>"$"+(l>=1e6?(l/1e6).toFixed(2)+"M":l>=1e3?(l/1e3).toFixed(0)+"k":l.toFixed(0))},{key:"funding_rate",label:"资金费率",format:l=>(l*100).toFixed(4)+"%"},{key:"slip_bps_n2",label:"冲击成本 N2 (bps)",format:l=>l.toFixed(2)}].forEach(({key:l,label:g,format:s})=>{const r=document.createElement("div");r.className="chart-row";const u=document.createElement("p");u.className="chart-row-label",u.textContent=g,r.appendChild(u);const d=document.createElement("div");d.className="chart-group",o.forEach(b=>{const C=n[b]||[],m=ue(b),p=document.createElement("div");p.className="chart-card";const h=document.createElement("div");h.className="chart-card-header";const k=document.createElement("span");k.className="chart-dot",k.style.background=m;const w=document.createElement("span");w.className="chart-venue-name",w.textContent=b.toUpperCase();const I=C.length>0?C[C.length-1]:null,B=I?Number(I[l]):null,x=document.createElement("span");x.className="chart-latest-val",x.textContent=Number.isFinite(B)?s(B):"-",h.appendChild(k),h.appendChild(w),h.appendChild(x);const N=document.createElement("canvas");N.className="sparkline-canvas",p.appendChild(h),p.appendChild(N),d.appendChild(p),requestAnimationFrame(()=>{pe(N,C,l,{color:m,format:s})})}),r.appendChild(d),t.appendChild(r)})}const i={tokenSwitcher:document.getElementById("token-switcher"),tokenName:document.getElementById("token-name"),dbPath:document.getElementById("db-path"),updatedAt:document.getElementById("updated-at"),collectorStatusText:document.getElementById("collector-status-text"),collectorStatusExtra:document.getElementById("collector-status-extra"),collectorError:document.getElementById("collector-error"),refreshBtn:document.getElementById("refresh-btn"),collectBtn:document.getElementById("collect-btn"),refreshHint:document.getElementById("refresh-hint"),refreshStatus:document.getElementById("refresh-status"),errorBox:document.getElementById("error-box"),kpiVenueCount:document.getElementById("kpi-venue-count"),kpiOnlineCount:document.getElementById("kpi-online-count"),kpiAlerts24h:document.getElementById("kpi-alerts-24h"),kpiCritical24h:document.getElementById("kpi-critical-24h"),kpiAvgSpread:document.getElementById("kpi-avg-spread"),kpiTotalDepth:document.getElementById("kpi-total-depth"),venueTbody:document.getElementById("venue-tbody"),trendSummary:document.getElementById("trend-summary")};function fe(){return i}function A(e){i.refreshBtn.disabled=e,i.refreshBtn.textContent=e?"刷新中...":"立即刷新"}function _(e,n){i.refreshStatus.textContent=`状态：${e}`,i.refreshStatus.className=`refresh-status ${n||"status-running"}`}function T(e){if(!e){i.errorBox.classList.add("hidden"),i.errorBox.textContent="";return}i.errorBox.textContent=e,i.errorBox.classList.remove("hidden")}function be(e){if(!e){i.collectorStatusText.textContent="未知",i.collectorStatusText.className="collector-stopped",i.collectorStatusExtra.textContent="",i.collectorError.classList.add("hidden");return}const n=e.service_status||"unknown",o={running:"运行中",degraded:"异常恢复中",stale:"数据陈旧",stopped:"已停止"},t={running:"collector-ok",degraded:"collector-degraded",stale:"collector-stale",stopped:"collector-stopped"};i.collectorStatusText.textContent=o[n]??"未知",i.collectorStatusText.className=t[n]??"collector-stopped";const c=e.last_success_age_seconds;let l=typeof c=="number"?`（上次成功 ${c}s 前）`:"";i.collectorStatusExtra.textContent=l,i.collectorError.classList.add("hidden")}function he(e){const n=e.venues||[],o=e.stats||{},t=n.filter(s=>s.status==="ok").length,c=n.map(s=>s.spread_bps).filter(s=>typeof s=="number"),l=c.length>0?c.reduce((s,r)=>s+r,0)/c.length:null,g=n.reduce((s,r)=>s+(Number(r.depth_1pct_total_usdt)||0),0);i.kpiVenueCount.textContent=String(o.venue_count??n.length??0),i.kpiOnlineCount.textContent=String(t),i.kpiAlerts24h.textContent=String(o.alerts_24h??0),i.kpiCritical24h.textContent=String(o.critical_alerts_24h??0),i.kpiAvgSpread.textContent=G(l,2),i.kpiTotalDepth.textContent=`$${G(g,0)}`}function me(e,n,o){const t=de(n),c=Number(o);return e==="ok"?t===null?"状态正常":t<=2?"刚刚更新":`${t}s 前更新`:e==="stale"?Number.isFinite(c)&&c>=0?`数据 ${c}s 未更新`:"数据陈旧":t!==null?`上次成功 ${t}s 前`:"暂无成功样本"}function Ie(e){const o=(e.venues||[]).map(t=>{const c=t?.ratios?.depth_vs_baseline;return`
    <tr>
      <td>
        <strong>${a((t.venue||"-").toUpperCase())}</strong>
        <p class="tiny">${a(t.symbol||"-")}</p>
      </td>
      <td>
        <span class="status-tag status-${a(t.status||"down")}">
          ${a(t.status||"down")}
        </span>
        <p class="tiny">${a(me(t.status,t.last_success_ts_utc||t.snapshot_ts_utc,t.snapshot_age_seconds))}</p>
        ${t.error_reason&&t.status!=="ok"?`<p class="tiny">${a(t.error_reason)}</p>`:""}
      </td>
      <td>${a(G(t.last_price,6))}</td>
      <td class="${a(ce(t.pct_change_1h))}">${a(le(t.pct_change_1h))}</td>
      <td>$${a(G(t.quote_volume_24h,0))}</td>
      <td>${a(G(t.spread_bps,2))}</td>
      <td>$${a(G(t.depth_1pct_total_usdt,0))}</td>
      <td>${a(G(t.slip_bps_n2,2))}</td>
      <td class="${a(re(t.funding_rate))}">${a(ie(t.funding_rate))}</td>
      <td>$${a(G(t.open_interest_usd,0))}</td>
      <td>
        <span class="${a(ae(c))}">
          ${a(c==null?"-":`${Number(c).toFixed(2)}x`)}
        </span>
      </td>
    </tr>`}).join("");i.venueTbody.innerHTML=o||'<tr><td colspan="11">暂无数据</td></tr>'}function Ce(e){const n=e?.by_venue||{};if(Object.keys(n).length===0){i.trendSummary&&(i.trendSummary.textContent="暂无趋势数据"),Y(e);return}i.trendSummary&&(i.trendSummary.textContent=""),Y(e)}function ye(e){i.tokenName.textContent=e.token_hint||"TOKEN",i.dbPath.textContent=e.db_path||"-",i.updatedAt.textContent=se(e.updated_at_utc),be(e.collector),he(e),Ie(e)}function P(e,n,o){if(i.tokenSwitcher){if(!e||e.length<=1){i.tokenSwitcher.classList.add("hidden");return}i.tokenSwitcher.classList.remove("hidden"),i.tokenSwitcher.innerHTML=e.map(t=>`
    <button class="token-pill${t===n?" active":""}" data-token="${a(t)}">
      ${a(t)}
    </button>`).join(""),o&&i.tokenSwitcher.querySelectorAll(".token-pill").forEach(t=>{t.addEventListener("click",()=>o(t.dataset.token))})}}const R=96,J=.85,M=3e-4;function Q(e){return e.length>0?e[e.length-1]:null}function E(e){return e.length===0?null:e.reduce((n,o)=>n+o,0)/e.length}function z(e,n){if(e.length===0)return null;const o=[...e].sort((g,s)=>g-s),t=(o.length-1)*n,c=Math.floor(t),l=Math.ceil(t);return o[c]+(o[l]-o[c])*(t-c)}function q(e){const n=e.length;if(n<2)return 0;const o=e.slice(-Math.min(n,12)),t=E(o.slice(-6)),c=E(o.slice(0,6));return t===null||c===null||c===0?0:(t-c)/c}function H(e,n){for(let o=e.length-1;o>=0;o--){const t=Number(e[o][n]);if(Number.isFinite(t))return t}return null}function v(e,n){return e.map(o=>Number(o[n])).filter(o=>Number.isFinite(o))}function ke(e,n){const o=v(n,"last_price");if(o.length<10)return{score:0,detail:"价格数据不足"};const t=o.slice(-Math.min(o.length,R)),c=Q(t),l=t.slice(0,-1),g=c>Math.max(...l),s=c<Math.min(...l),r=q(t);return g?{score:1,detail:`创新高 斜率 ${(r*100).toFixed(2)}%`,direction:"long"}:s?{score:1,detail:`创新低 斜率 ${(r*100).toFixed(2)}%`,direction:"short"}:r>.005?{score:.5,detail:`上行趋势 斜率 ${(r*100).toFixed(2)}%`,direction:"long"}:r<-.005?{score:.5,detail:`下行趋势 斜率 ${(r*100).toFixed(2)}%`,direction:"short"}:{score:0,detail:"无明显方向",direction:"flat"}}function Be(e,n){const o=v(n,"open_interest_usd"),t=v(n,"funding_rate");if(o.length<6)return{score:0,detail:"OI 数据不足",crowded:!1};const c=o.slice(-Math.min(o.length,R)),l=q(c),g=l>.005,s=l<-.005;let r=!1,u="neutral",d=null;if(t.length>=6){const m=t.slice(-Math.min(t.length,R));d=Q(m);const p=z(m,J),h=z(m,1-J),k=d!==null&&d>=M,w=d!==null&&d<=-M,I=d!==null&&p!==null&&d>=p,B=d!==null&&h!==null&&d<=h;I||k?(r=!0,u="long_crowded"):B||w?(r=!0,u="short_crowded"):d!==null&&(u=d>0?"long_mild":d<0?"short_mild":"neutral")}const b=d!==null?(d*100).toFixed(4)+"%":"-",C=(l*100).toFixed(2)+"%";return g&&!r?{score:1,detail:`OI 增仓 ${C} 费率温和 ${b}`,crowded:!1,frDirection:u,oiTrend:"rising"}:g&&r?{score:.5,detail:`OI 增仓但费率极端 ${b}，拥挤风险`,crowded:!0,frDirection:u,oiTrend:"rising"}:s?{score:0,detail:`OI 去杠杆 ${C} 费率 ${b}`,crowded:!1,frDirection:u,oiTrend:"falling",deleveraging:!0}:{score:.3,detail:`OI 横盘 费率 ${b}`,crowded:r,frDirection:u,oiTrend:"flat"}}function xe(e,n,o){const t=v(n,"spread_bps"),c=v(n,"depth_1pct_total_usdt"),l=v(n,"slip_bps_n2"),g=H(n,"spread_bps"),s=H(n,"depth_1pct_total_usdt"),r=H(n,"slip_bps_n2"),u=[];let d=0,b=!1;if(t.length>=6){b=!0;const p=E(t.slice(0,Math.max(1,t.length-6)));p&&g!==null&&g>p*2?(u.push(`价差扩大 ${g.toFixed(2)} bps`),d++):g!==null&&u.push(`价差 ${g.toFixed(2)} bps`)}if(c.length>=6){b=!0;const p=E(c.slice(0,Math.max(1,c.length-6)));p&&s!==null&&s<p*.5?(u.push(`深度萎缩 $${(s/1e3).toFixed(0)}k`),d++):s!==null&&u.push(`深度 $${(s/1e3).toFixed(0)}k`)}if(l.length>=6){b=!0;const p=E(l.slice(0,Math.max(1,l.length-6)));p&&r!==null&&r>p*2?(u.push(`N2 抬升 ${r.toFixed(2)} bps`),d++):r!==null&&u.push(`N2 ${r.toFixed(2)} bps`)}if(!b)return{score:1,detail:"执行数据不足，默认通过",degraded:!1};const C=d>=2;return{score:d===0?1:d===1?.5:0,detail:u.join(" · "),degraded:C,spreadNow:g,depthNow:s,n2Now:r}}function Se(e,n,o){const t=!o.degraded;if(!t)return{type:"filter",label:"执行质量差",description:"盘口恶化，暂不建议交易",confidence:0,color:"signal-filter"};if(n.deleveraging&&e.score>=.5){let c;return e.direction==="long"?c="short":e.direction==="short"?c="long":c=n.frDirection==="long_crowded"||n.frDirection==="long_mild"?"short":"long",{type:"reversal",label:"清算释放",description:"OI 去杠杆后回摆机会，等下一根四小时确认",confidence:Math.round((e.score+(n.score>0?.5:.3))*50),direction:c,color:"signal-reversal"}}return n.crowded&&e.score>=.5?{type:"squeeze",label:"挤仓突破",description:"OI 增仓但费率极端，波动加速或反转，小仓快进快出",confidence:Math.round(e.score*60),direction:e.direction,color:"signal-squeeze"}:e.score>=.5&&n.score>=.8&&t?{type:"trend",label:"顺势延续",description:"价格突破 + OI 增仓 + 执行质量良好，跟随四小时趋势",confidence:Math.round((e.score+n.score)/2*100),direction:e.direction,color:"signal-trend"}:{type:"wait",label:"观望",description:"信号强度不足，等待更清晰的结构",confidence:0,color:"signal-wait"}}function Ge(e,n){const o=e?.by_venue||{};return Object.keys(o).map(c=>{const l=o[c]||[];if(l.length<6)return{venue:c,signal:{type:"wait",label:"数据不足",description:"历史数据过少，无法计算信号",confidence:0,color:"signal-wait"},components:{}};n?.find(d=>d.venue===c);const g=ke(c,l),s=Be(c,l),r=xe(c,l),u=Se(g,s,r);return{venue:c,signal:u,components:{price:g,oi:s,exec:r}}})}const j={trend:{label:"顺势延续",icon:"&#8593;",bg:"#f0fdf4",border:"#86efac",badge:"#15803d",badgeBg:"#dcfce7"},squeeze:{label:"挤仓突破",icon:"&#9888;",bg:"#fffbeb",border:"#fde68a",badge:"#b45309",badgeBg:"#fef3c7"},reversal:{label:"清算释放",icon:"&#8635;",bg:"#f0f9ff",border:"#7dd3fc",badge:"#0369a1",badgeBg:"#e0f2fe"},filter:{label:"过滤",icon:"&#8856;",bg:"#fff1f2",border:"#fda4af",badge:"#be123c",badgeBg:"#ffe4e6"},wait:{label:"观望",icon:"&#8211;",bg:"#f8fafc",border:"#e2e8f0",badge:"#64748b",badgeBg:"#f1f5f9"}},we={long:"做多",short:"做空",flat:"横盘"},F={price:[{cond:"创历史新高（lookback 96 点）",out:"score=1 · 方向做多"},{cond:"创历史新低（lookback 96 点）",out:"score=1 · 方向做空"},{cond:"斜率 > +0.5%（最近 12 点前后半段均值比）",out:"score=0.5 · 方向做多"},{cond:"斜率 < -0.5%",out:"score=0.5 · 方向做空"},{cond:"以上均不满足",out:"score=0 · 观望"}],oi:[{cond:"OI 斜率 > +0.5% 且资金费率未到极端",out:"score=1 · 增仓不拥挤"},{cond:"OI 斜率 > +0.5% 且资金费率极端",out:"score=0.5 · 增仓但拥挤"},{cond:"OI 斜率 < -0.5%",out:"score=0 · 去杠杆（触发清算释放条件）"},{cond:"以上均不满足",out:"score=0.3 · 横盘"},{cond:"费率极端判定",out:"百分位 ≥85% 或 ≤15%，或绝对值 ≥0.03%（双条件取并集）"}],exec:[{cond:"价差 > 基线（前段均值）× 1.5",out:"恶化 · 触发过滤"},{cond:"1% 深度 < 基线 × 0.7",out:"恶化 · 触发过滤"},{cond:"冲击成本 N2 > 基线 × 1.5",out:"恶化 · 触发过滤"},{cond:"以上均正常",out:"执行质量良好"},{cond:"基线定义",out:"同字段最近 96 点中去除末尾 6 点的均值"}],classify:[{cond:"执行质量恶化（任意一项）",out:"→ 过滤，不交易"},{cond:"OI 去杠杆 且 价格 score ≥ 0.5",out:"→ 清算释放（价格有方向时取反，flat 时依据费率方向）"},{cond:"OI 拥挤 且 价格 score ≥ 0.5",out:"→ 挤仓突破（同向，小仓快出）"},{cond:"价格 score ≥ 0.5 且 OI score ≥ 0.8 且 执行质量正常",out:"→ 顺势延续"},{cond:"其余",out:"→ 观望"}]};function Z(e){return`<table class="logic-table">
    <thead><tr><th>条件</th><th>结果</th></tr></thead>
    <tbody>${e.map(n=>`<tr><td>${a(n.cond)}</td><td>${a(n.out)}</td></tr>`).join("")}</tbody>
  </table>`}function Ne(){return`<div class="logic-panel" id="logic-panel">
    <div class="logic-section">
      <p class="logic-title">A · 价格结构（Price Breakout）</p>
      ${Z(F.price)}
    </div>
    <div class="logic-section">
      <p class="logic-title">B · 衍生品拥挤度（OI + Funding Rate）</p>
      ${Z(F.oi)}
    </div>
    <div class="logic-section">
      <p class="logic-title">C · 执行质量（Execution Quality）</p>
      ${Z(F.exec)}
    </div>
    <div class="logic-section">
      <p class="logic-title">D · 信号分类（Signal Classifier）</p>
      ${Z(F.classify)}
    </div>
  </div>`}function Ae(e){if(!e)return"";const n=Math.min(100,Math.max(0,e)),o=n>=70?"#15803d":n>=40?"#d97706":"#94a3b8";return`
    <div class="sig-conf-row">
      <span class="sig-conf-label">信号强度</span>
      <div class="sig-conf-track">
        <div class="sig-conf-fill" style="width:${n}%;background:${a(o)}"></div>
      </div>
      <span class="sig-conf-val">${n}%</span>
    </div>`}function $e(e){const n=Number(e);if(!Number.isFinite(n))return"";const o=n>=.8?"#15803d":n>=.5?"#d97706":"#94a3b8",t=n>=.8?"#dcfce7":n>=.5?"#fef3c7":"#f1f5f9";return`<span class="sig-score-chip" style="color:${o};background:${t}">${n.toFixed(1)}</span>`}function K(e,n,o,t){return`
    <div class="sig-comp-row">
      <span class="sig-comp-dot" style="background:${a(o?"#15803d":"#94a3b8")}"></span>
      <span class="sig-comp-label">${a(e)}</span>
      ${$e(t)}
      <span class="sig-comp-detail">${a(n||"-")}</span>
    </div>`}function _e(e){const n=j[e.signal.type]||j.wait,{price:o,oi:t,exec:c}=e.components,l=e.signal.direction&&we[e.signal.direction]||"",g=l?`<span class="sig-dir-tag sig-dir-${a(e.signal.direction)}">${a(l)}</span>`:"",s=o&&t&&c?`<div class="sig-components">
        ${K("A 价格结构",o.detail,o.score>=.5,o.score)}
        ${K("B 拥挤度",t.detail,t.score>=.5&&!t.crowded,t.score)}
        ${K("C 执行质量",c.detail,!c.degraded,c.degraded?0:1)}
      </div>`:"";return`
    <div class="signal-card" style="background:${a(n.bg)};border-color:${a(n.border)}">
      <div class="sig-header">
        <div class="sig-venue-row">
          <span class="sig-venue">${a(e.venue.toUpperCase())}</span>
          ${g}
        </div>
        <span class="sig-badge" style="color:${a(n.badge)};background:${a(n.badgeBg)}">
          ${n.icon}&nbsp;${a(e.signal.label)}
        </span>
      </div>
      <p class="sig-description">${a(e.signal.description)}</p>
      ${e.signal.confidence?Ae(e.signal.confidence):""}
      ${s}
    </div>`}let S=!1;function ve(e,n){const o=document.getElementById("signals-container");if(!o)return;const t=Ge(e,n);if(t.length===0){o.innerHTML='<p class="muted">暂无信号数据</p>';return}const c="sig-logic-toggle",l="sig-logic-body",g=S?"logic-body":"logic-body hidden",s=S?"&#9662;":"&#9656;";o.innerHTML=`
    <div class="signals-grid">${t.map(_e).join("")}</div>
    <div class="logic-disclosure">
      <button class="logic-toggle" id="${c}" aria-expanded="${S}">
        计算逻辑 &nbsp;<span class="logic-toggle-arrow" id="sig-logic-arrow">${s}</span>
      </button>
      <div class="${g}" id="${l}">
        ${Ne()}
      </div>
    </div>`,document.getElementById(c)?.addEventListener("click",()=>{const r=document.getElementById(l),u=document.getElementById("sig-logic-arrow");r&&(S=!S,r.classList.toggle("hidden",!S),u&&(u.innerHTML=S?"&#9662;":"&#9656;"),document.getElementById(c)?.setAttribute("aria-expanded",String(S)))})}const ee=15e3;let y=!1,X=ee,W=Date.now()+ee,$=null,V="MON",L=[];function te(e){e!==V&&(V=e,P(L,V,te),!y&&(y=!0,A(!0),$.postMessage({type:"setToken",token:e})))}function Ee(){const e=new URL("data:text/javascript;base64,bGV0IEJBU0UgPSAiIjsKbGV0IGF1dGhIZWFkZXJzID0ge307CmxldCBjdXJyZW50VG9rZW4gPSAiTU9OIjsKCmZ1bmN0aW9uIGluaXRDb25maWcodXJsLCBrZXkpIHsKICBCQVNFID0gYCR7dXJsfS9mdW5jdGlvbnMvdjFgOwogIGF1dGhIZWFkZXJzID0gewogICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke2tleX1gLAogICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICB9Owp9Cgphc3luYyBmdW5jdGlvbiBmZXRjaEpzb24ocGF0aCwgdGltZW91dE1zID0gMTIwMDApIHsKICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogIGNvbnN0IHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiBjb250cm9sbGVyLmFib3J0KCksIHRpbWVvdXRNcyk7CiAgdHJ5IHsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGAke0JBU0V9JHtwYXRofWAsIHsKICAgICAgaGVhZGVyczogYXV0aEhlYWRlcnMsCiAgICAgIGNhY2hlOiAibm8tc3RvcmUiLAogICAgICBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsLAogICAgfSk7CiAgICBpZiAoIXJlcy5vaykgdGhyb3cgbmV3IEVycm9yKGDor7fmsYLlpLHotKUgJHtyZXMuc3RhdHVzfTogJHtwYXRofWApOwogICAgcmV0dXJuIGF3YWl0IHJlcy5qc29uKCk7CiAgfSBmaW5hbGx5IHsKICAgIGNsZWFyVGltZW91dCh0aW1lcik7CiAgfQp9Cgphc3luYyBmdW5jdGlvbiBmZXRjaERhdGEoKSB7CiAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICJzdGF0dXMiLCBzdGF0dXM6ICJmZXRjaGluZyIgfSk7CgogIGNvbnN0IHRva2VuUSA9IGB0b2tlbj0ke2VuY29kZVVSSUNvbXBvbmVudChjdXJyZW50VG9rZW4pfWA7CiAgY29uc3QgW292ZXJ2aWV3LCBoaXN0b3J5XSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgIGZldGNoSnNvbihgL2FwaS1vdmVydmlldz8ke3Rva2VuUX1gKSwKICAgIGZldGNoSnNvbihgL2FwaS1oaXN0b3J5P2xpbWl0PTEyMCYke3Rva2VuUX1gKSwKICBdKTsKCiAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICJkYXRhIiwgb3ZlcnZpZXcsIGhpc3RvcnkgfSk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGZldGNoVG9rZW5MaXN0KCkgewogIHRyeSB7CiAgICBjb25zdCBkYXRhID0gYXdhaXQgZmV0Y2hKc29uKCIvYXBpLWFkbWluL3Rva2VucyIpOwogICAgY29uc3QgdG9rZW5zID0gKGRhdGEudG9rZW5zIHx8IFtdKS5maWx0ZXIoKHQpID0+IHQuZW5hYmxlZCkubWFwKCh0KSA9PiB0LnRva2VuKTsKICAgIHNlbGYucG9zdE1lc3NhZ2UoeyB0eXBlOiAidG9rZW5zIiwgdG9rZW5zIH0pOwogIH0gY2F0Y2ggewogICAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICJ0b2tlbnMiLCB0b2tlbnM6IFtjdXJyZW50VG9rZW5dIH0pOwogIH0KfQoKYXN5bmMgZnVuY3Rpb24gcnVuRmV0Y2goKSB7CiAgdHJ5IHsKICAgIGF3YWl0IGZldGNoRGF0YSgpOwogIH0gY2F0Y2ggKGVycikgewogICAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICJlcnJvciIsIG1lc3NhZ2U6IGVycj8ubWVzc2FnZSB8fCBTdHJpbmcoZXJyKSB9KTsKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJ1bkNvbGxlY3QoKSB7CiAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICJzdGF0dXMiLCBzdGF0dXM6ICJjb2xsZWN0aW5nIiB9KTsKCiAgdHJ5IHsKICAgIGF3YWl0IGZldGNoSnNvbigiL2NvbGxlY3QtbW9uIik7CiAgICBhd2FpdCBmZXRjaERhdGEoKTsKICB9IGNhdGNoIChlcnIpIHsKICAgIHNlbGYucG9zdE1lc3NhZ2UoeyB0eXBlOiAiZXJyb3IiLCBtZXNzYWdlOiBlcnI/Lm1lc3NhZ2UgfHwgU3RyaW5nKGVycikgfSk7CiAgfQp9CgpzZWxmLm9ubWVzc2FnZSA9IChlKSA9PiB7CiAgY29uc3QgeyB0eXBlLCBzdXBhYmFzZVVybCwgYW5vbktleSwgdG9rZW4gfSA9IGUuZGF0YTsKCiAgaWYgKHR5cGUgPT09ICJpbml0IikgewogICAgaW5pdENvbmZpZyhzdXBhYmFzZVVybCwgYW5vbktleSk7CiAgICBmZXRjaFRva2VuTGlzdCgpOwogICAgcnVuRmV0Y2goKTsKICAgIHJldHVybjsKICB9CgogIGlmICh0eXBlID09PSAic2V0VG9rZW4iKSB7CiAgICBjdXJyZW50VG9rZW4gPSB0b2tlbjsKICAgIHJ1bkZldGNoKCk7CiAgICByZXR1cm47CiAgfQoKICBpZiAodHlwZSA9PT0gImZldGNoIikgewogICAgcnVuRmV0Y2goKTsKICAgIHJldHVybjsKICB9CgogIGlmICh0eXBlID09PSAiY29sbGVjdCIpIHsKICAgIHJ1bkNvbGxlY3QoKTsKICAgIHJldHVybjsKICB9Cn07Cg==",import.meta.url);$=new Worker(e,{type:"module"}),$.onmessage=n=>{const o=n.data;if(o.type==="tokens"){L=o.tokens,P(L,V,te);return}if(o.type==="status"){o.status==="collecting"?_("采集中...","status-loading"):o.status==="fetching"&&_("读取数据中...","status-loading");return}if(o.type==="data"){ye(o.overview),Ce(o.history),ve(o.history,o.overview?.venues),T(""),W=Date.now()+X;const t=new Date().toLocaleTimeString("zh-CN",{hour12:!1});_(`采集完成 ${t}`,"status-success"),y=!1,A(!1);return}if(o.type==="error"){T(o.message),_("采集失败","status-error"),W=Date.now()+X,y=!1,A(!1);return}},$.onerror=n=>{T(n.message||"Worker 错误"),_("Worker 错误","status-error"),y=!1,A(!1)}}function Fe(){y||(y=!0,A(!0),$.postMessage({type:"fetch"}))}function D(){y||(y=!0,A(!0),$.postMessage({type:"collect"}))}function Ze(){const e=fe();Ee(),e.refreshBtn.addEventListener("click",Fe),e.collectBtn&&e.collectBtn.addEventListener("click",D),W=Date.now()+X,_("启动中...","status-loading"),y=!0,A(!0),$.postMessage({type:"init",supabaseUrl:"https://joisixcdkdihqduxllzn.supabase.co",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpvaXNpeGNka2RpaHFkdXhsbHpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODM2NjYsImV4cCI6MjA4NzA1OTY2Nn0.3v-G_lTJOnex0am3BLMgGA97_ZZ3tg9j8tXdDsN2H-U"}),setInterval(()=>{!y&&Date.now()>=W&&D()},1e3)}Ze();
