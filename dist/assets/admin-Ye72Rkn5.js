import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css               */const y="https://joisixcdkdihqduxllzn.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpvaXNpeGNka2RpaHFkdXhsbHpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODM2NjYsImV4cCI6MjA4NzA1OTY2Nn0.3v-G_lTJOnex0am3BLMgGA97_ZZ3tg9j8tXdDsN2H-U",E=`${y}/functions/v1/api-admin`,B={Authorization:`Bearer ${p}`,"Content-Type":"application/json"};async function r(t,o={}){const n=await fetch(`${E}${t}`,{...o,headers:{...B,...o.headers}}),a=await n.json();if(!n.ok)throw new Error(a.error||`HTTP ${n.status}`);return a}let s=[],i=null;const e={error:document.getElementById("admin-error"),collectorStatus:document.getElementById("admin-collector-status"),lastCycle:document.getElementById("admin-last-cycle"),snapshotCount:document.getElementById("admin-snapshot-count"),alertCount:document.getElementById("admin-alert-count"),tokenTbody:document.getElementById("token-tbody"),tokenEmpty:document.getElementById("token-empty"),tokenTable:document.getElementById("token-table"),addBtn:document.getElementById("add-token-btn"),modal:document.getElementById("token-modal"),modalTitle:document.getElementById("modal-title"),modalClose:document.getElementById("modal-close"),modalCancel:document.getElementById("modal-cancel"),modalSubmit:document.getElementById("modal-submit"),form:document.getElementById("token-form"),formId:document.getElementById("form-id"),formToken:document.getElementById("form-token"),formEnabled:document.getElementById("form-enabled"),formBinance:document.getElementById("form-binance"),formOkx:document.getElementById("form-okx"),formBybit:document.getElementById("form-bybit"),formNote:document.getElementById("form-note"),formError:document.getElementById("form-error"),lookupBtn:document.getElementById("lookup-btn"),lookupStatus:document.getElementById("lookup-status"),confirmModal:document.getElementById("confirm-modal"),confirmText:document.getElementById("confirm-text"),confirmCancel:document.getElementById("confirm-cancel"),confirmOk:document.getElementById("confirm-ok")};function c(t){if(!t){e.error.classList.add("hidden");return}e.error.textContent=t,e.error.classList.remove("hidden")}function I(t){if(!t)return"-";const o=Math.floor((Date.now()-new Date(t).getTime())/1e3);return o<5?"刚刚":o<60?`${o}s 前`:o<3600?`${Math.floor(o/60)}m 前`:`${Math.floor(o/3600)}h 前`}async function g(){try{const t=await r("/collector/status"),o=t.state||{},n=o.service_status||"unknown",a={running:"运行中",degraded:"异常",stopped:"已停止",unknown:"未知"},h={running:"collector-ok",degraded:"collector-degraded",stopped:"collector-stopped",unknown:"collector-stopped"};e.collectorStatus.textContent=a[n]??"未知",e.collectorStatus.className=`status-box-value ${h[n]??"collector-stopped"}`,e.lastCycle.textContent=o.last_cycle_end_utc?`上次: ${I(o.last_cycle_end_utc)}`:"-",e.snapshotCount.textContent=String(t.total_snapshots??0),e.alertCount.textContent=String(t.alerts_24h??0)}catch{e.collectorStatus.textContent="获取失败"}}async function b(){try{s=(await r("/tokens")).tokens||[],f(),c("")}catch(t){c(`加载币种失败: ${t.message}`)}}function f(){if(s.length===0){e.tokenEmpty.classList.remove("hidden"),e.tokenTable.classList.add("hidden");return}e.tokenEmpty.classList.add("hidden"),e.tokenTable.classList.remove("hidden"),e.tokenTbody.innerHTML=s.map(t=>`
    <tr>
      <td><strong>${l(t.token)}</strong></td>
      <td>
        <label class="toggle toggle-sm">
          <input type="checkbox" class="toggle-enabled" data-id="${t.id}" ${t.enabled?"checked":""} />
          <span class="toggle-slider"></span>
        </label>
        <span class="tiny ${t.enabled?"collector-ok":"muted"}">${t.enabled?"采集中":"已暂停"}</span>
      </td>
      <td><code>${l(t.binance_symbol||"-")}</code></td>
      <td><code>${l(t.okx_inst_id||"-")}</code></td>
      <td><code>${l(t.bybit_symbol||"-")}</code></td>
      <td class="muted">${l(t.note||"-")}</td>
      <td>
        <div class="action-btns">
          <button class="action-btn edit-btn" data-id="${t.id}">编辑</button>
          <button class="action-btn delete-btn" data-id="${t.id}" data-token="${l(t.token)}">删除</button>
        </div>
      </td>
    </tr>
  `).join(""),e.tokenTbody.querySelectorAll(".edit-btn").forEach(t=>{t.addEventListener("click",()=>C(Number(t.dataset.id)))}),e.tokenTbody.querySelectorAll(".delete-btn").forEach(t=>{t.addEventListener("click",()=>x(Number(t.dataset.id),t.dataset.token))}),e.tokenTbody.querySelectorAll(".toggle-enabled").forEach(t=>{t.addEventListener("change",()=>L(Number(t.dataset.id),t.checked))})}function l(t){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function d(t,o){if(!t){e.lookupStatus.classList.add("hidden");return}e.lookupStatus.textContent=t,e.lookupStatus.className=`lookup-status ${o}`,e.lookupStatus.classList.remove("hidden")}async function v(){const t=e.formToken.value.trim();if(!t){d("请先输入币种名称","error");return}e.lookupBtn.disabled=!0,e.lookupBtn.textContent="查找中...",d("正在查询各交易所...","loading");try{const o=await fetch(`${y}/functions/v1/api-lookup?token=${encodeURIComponent(t)}`,{headers:{Authorization:`Bearer ${p}`}}),n=await o.json();if(!o.ok)throw new Error(n.error||`HTTP ${o.status}`);const a=[];n.binance&&(e.formBinance.value=n.binance,a.push(`Binance: ${n.binance}`)),n.okx&&(e.formOkx.value=n.okx,a.push(`OKX: ${n.okx}`)),n.bybit&&(e.formBybit.value=n.bybit,a.push(`Bybit: ${n.bybit}`)),a.length>0?d(`已找到 ${a.length} 个交易所: ${a.join(" / ")}`,"success"):d("未找到对应合约，请手动填写","error")}catch(o){d(`查找失败: ${o.message}`,"error")}finally{e.lookupBtn.disabled=!1,e.lookupBtn.textContent="自动查找"}}function $(){e.modalTitle.textContent="添加币种",e.formId.value="",e.form.reset(),e.formEnabled.checked=!0,e.formError.classList.add("hidden"),d("",""),e.modal.classList.remove("hidden"),e.formToken.focus()}function C(t){const o=s.find(n=>n.id===t);o&&(e.modalTitle.textContent=`编辑 ${o.token}`,e.formId.value=String(t),e.formToken.value=o.token,e.formEnabled.checked=o.enabled,e.formBinance.value=o.binance_symbol||"",e.formOkx.value=o.okx_inst_id||"",e.formBybit.value=o.bybit_symbol||"",e.formNote.value=o.note||"",e.formError.classList.add("hidden"),d("",""),e.modal.classList.remove("hidden"))}function u(){e.modal.classList.add("hidden")}function x(t,o){i=t,e.confirmText.textContent=`确定要删除币种 ${o} 吗？删除后将停止采集，历史数据保留。`,e.confirmModal.classList.remove("hidden")}let k=!1;function m(){i=null,e.confirmModal.classList.add("hidden"),k=!0,setTimeout(()=>{k=!1},100)}async function L(t,o){try{await r(`/tokens/${t}`,{method:"PUT",body:JSON.stringify({enabled:o})});const n=s.find(a=>a.id===t);n&&(n.enabled=o),f()}catch(n){c(`更新失败: ${n.message}`),f()}}async function T(t){t.preventDefault();const o=e.formId.value,n={token:e.formToken.value.trim(),enabled:e.formEnabled.checked,binance_symbol:e.formBinance.value.trim(),okx_inst_id:e.formOkx.value.trim(),bybit_symbol:e.formBybit.value.trim(),note:e.formNote.value.trim()};e.modalSubmit.disabled=!0,e.modalSubmit.textContent="保存中...",e.formError.classList.add("hidden");try{o?await r(`/tokens/${o}`,{method:"PUT",body:JSON.stringify(n)}):await r("/tokens",{method:"POST",body:JSON.stringify(n)}),u(),await b()}catch(a){e.formError.textContent=`保存失败: ${a.message}`,e.formError.classList.remove("hidden")}finally{e.modalSubmit.disabled=!1,e.modalSubmit.textContent="保存"}}async function S(){if(i===null)return;const t=i;e.confirmOk.disabled=!0,e.confirmOk.textContent="删除中...";try{await r(`/tokens/${t}`,{method:"DELETE"}),m(),await b()}catch(o){c(`删除失败: ${o.message}`),m()}finally{e.confirmOk.disabled=!1,e.confirmOk.textContent="删除"}}e.lookupBtn.addEventListener("click",v);e.addBtn.addEventListener("click",$);e.modalClose.addEventListener("click",u);e.modalCancel.addEventListener("click",u);e.modal.addEventListener("click",t=>{!k&&t.target===e.modal&&u()});e.form.addEventListener("submit",T);e.confirmCancel.addEventListener("click",t=>{t.stopPropagation(),m()});e.confirmOk.addEventListener("click",t=>{t.stopPropagation(),S()});e.confirmModal.addEventListener("click",t=>{t.stopPropagation(),t.target===e.confirmModal&&m()});g();b();setInterval(g,3e4);
