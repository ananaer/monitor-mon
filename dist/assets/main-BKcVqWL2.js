import"./styles-xNwCq-SC.js";function N(t,n=2){return t==null||Number.isNaN(t)?"-":Number(t).toLocaleString("zh-CN",{maximumFractionDigits:n,minimumFractionDigits:n>0?Math.min(n,2):0})}function z(t){return t==null||Number.isNaN(t)?"-":`${t>0?"+":""}${Number(t).toFixed(2)}%`}function K(t){if(!t)return"-";const n=new Date(t);return Number.isNaN(n.getTime())?t:n.toLocaleString("zh-CN",{hour12:!1})}function j(t){if(!t)return null;const n=new Date(t);return Number.isNaN(n.getTime())?null:Math.max(0,Math.floor((Date.now()-n.getTime())/1e3))}function O(t){return t==null?"":t>0?"up":t<0?"down":""}function D(t){if(t==null||Number.isNaN(t))return"-";const n=Number(t)*100;return`${n>0?"+":""}${n.toFixed(4)}%`}function M(t){if(t==null)return"";const n=Number(t)*100;return n>.05?"up":n<-.05?"down":""}function U(t){return t==null?"ratio-neutral":t>=1?"ratio-good":t>=.7?"ratio-mid":"ratio-bad"}function l(t){return String(t??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}const P={binance:"#f0b90b",okx:"#1677ff",bybit:"#ff6b35"},_="#0e7490";function Q(t){return P[t?.toLowerCase()]??_}function q(t,n,r,e={}){const c=window.devicePixelRatio||1,i=t.offsetWidth||300,m=t.offsetHeight||80;t.width=i*c,t.height=m*c;const o=t.getContext("2d");o.scale(c,c),o.clearRect(0,0,i,m);const a=n.map(d=>Number(d[r])).filter(d=>Number.isFinite(d));if(a.length<2){o.fillStyle="#94a3b8",o.font="11px sans-serif",o.textAlign="center",o.fillText("数据不足",i/2,m/2);return}const C=4,p=8,x=18,Z=i-C*2,B=m-p-x;let u=Math.min(...a),I=Math.max(...a);const f=I-u||Math.abs(u)*.01||1;u-=f*.05,I+=f*.05;const w=I-u,h=d=>C+d/(a.length-1)*Z,b=d=>p+(1-(d-u)/w)*B,y=e.color||_,A=o.createLinearGradient(0,p,0,p+B);A.addColorStop(0,y+"40"),A.addColorStop(1,y+"00"),o.beginPath(),o.moveTo(h(0),b(a[0]));for(let d=1;d<a.length;d++)o.lineTo(h(d),b(a[d]));o.lineTo(h(a.length-1),p+B),o.lineTo(h(0),p+B),o.closePath(),o.fillStyle=A,o.fill(),o.beginPath(),o.moveTo(h(0),b(a[0]));for(let d=1;d<a.length;d++)o.lineTo(h(d),b(a[d]));o.strokeStyle=y,o.lineWidth=1.5,o.lineJoin="round",o.stroke();const v=h(a.length-1),$=b(a[a.length-1]);o.beginPath(),o.arc(v,$,3,0,Math.PI*2),o.fillStyle=y,o.fill();const R=e.format||(d=>d.toFixed(2));o.fillStyle="#64748b",o.font="10px sans-serif",o.textAlign="left",o.fillText(R(u+f*.05),C,m-4),o.textAlign="right",o.fillText(R(I-f*.05),i-C,m-4)}function L(t){const n=t?.by_venue||{},r=Object.keys(n),e=document.getElementById("trend-charts");if(!e)return;if(e.innerHTML="",r.length===0){e.innerHTML='<p class="muted">暂无趋势数据</p>';return}[{key:"last_price",label:"价格",format:i=>i.toFixed(6)},{key:"spread_bps",label:"价差 (bps)",format:i=>i.toFixed(2)},{key:"depth_1pct_total_usdt",label:"1% 深度 (USDT)",format:i=>"$"+(i>=1e3?(i/1e3).toFixed(1)+"k":i.toFixed(0))}].forEach(({key:i,label:m,format:o})=>{const a=document.createElement("div");a.className="chart-row";const C=document.createElement("p");C.className="chart-row-label",C.textContent=m,a.appendChild(C);const p=document.createElement("div");p.className="chart-group",r.forEach(x=>{const Z=n[x]||[],B=Q(x),u=document.createElement("div");u.className="chart-card";const I=document.createElement("div");I.className="chart-card-header";const f=document.createElement("span");f.className="chart-dot",f.style.background=B;const w=document.createElement("span");w.className="chart-venue-name",w.textContent=x.toUpperCase();const h=Z.length>0?Z[Z.length-1]:null,b=h?Number(h[i]):null,y=document.createElement("span");y.className="chart-latest-val",y.textContent=Number.isFinite(b)?o(b):"-",I.appendChild(f),I.appendChild(w),I.appendChild(y);const A=document.createElement("canvas");A.className="sparkline-canvas",u.appendChild(I),u.appendChild(A),p.appendChild(u),requestAnimationFrame(()=>{q(A,Z,i,{color:B,format:o})})}),a.appendChild(p),e.appendChild(a)})}const s={tokenSwitcher:document.getElementById("token-switcher"),tokenName:document.getElementById("token-name"),dbPath:document.getElementById("db-path"),updatedAt:document.getElementById("updated-at"),collectorStatusText:document.getElementById("collector-status-text"),collectorStatusExtra:document.getElementById("collector-status-extra"),collectorError:document.getElementById("collector-error"),refreshBtn:document.getElementById("refresh-btn"),collectBtn:document.getElementById("collect-btn"),refreshHint:document.getElementById("refresh-hint"),refreshStatus:document.getElementById("refresh-status"),errorBox:document.getElementById("error-box"),kpiVenueCount:document.getElementById("kpi-venue-count"),kpiOnlineCount:document.getElementById("kpi-online-count"),kpiAlerts24h:document.getElementById("kpi-alerts-24h"),kpiCritical24h:document.getElementById("kpi-critical-24h"),kpiAvgSpread:document.getElementById("kpi-avg-spread"),kpiTotalDepth:document.getElementById("kpi-total-depth"),venueTbody:document.getElementById("venue-tbody"),trendSummary:document.getElementById("trend-summary"),alertCount:document.getElementById("alert-count"),alertEmpty:document.getElementById("alert-empty"),alertList:document.getElementById("alert-list")};function tt(){return s}function k(t){s.refreshBtn.disabled=t,s.refreshBtn.textContent=t?"刷新中...":"立即刷新"}function S(t,n){s.refreshStatus.textContent=`状态：${t}`,s.refreshStatus.className=`refresh-status ${n||"status-running"}`}function E(t){if(!t){s.errorBox.classList.add("hidden"),s.errorBox.textContent="";return}s.errorBox.textContent=t,s.errorBox.classList.remove("hidden")}function et(t){if(!t){s.collectorStatusText.textContent="未知",s.collectorStatusText.className="collector-stopped",s.collectorStatusExtra.textContent="",s.collectorError.classList.add("hidden");return}const n=t.service_status||"unknown",r={running:"运行中",degraded:"异常恢复中",stale:"数据陈旧",stopped:"已停止"},e={running:"collector-ok",degraded:"collector-degraded",stale:"collector-stale",stopped:"collector-stopped"};s.collectorStatusText.textContent=r[n]??"未知",s.collectorStatusText.className=e[n]??"collector-stopped";const c=t.last_success_age_seconds;let i=typeof c=="number"?`（上次成功 ${c}s 前）`:"";s.collectorStatusExtra.textContent=i,s.collectorError.classList.add("hidden")}function nt(t){const n=t.venues||[],r=t.stats||{},e=n.filter(o=>o.status==="ok").length,c=n.map(o=>o.spread_bps).filter(o=>typeof o=="number"),i=c.length>0?c.reduce((o,a)=>o+a,0)/c.length:null,m=n.reduce((o,a)=>o+(Number(a.depth_1pct_total_usdt)||0),0);s.kpiVenueCount.textContent=String(r.venue_count??n.length??0),s.kpiOnlineCount.textContent=String(e),s.kpiAlerts24h.textContent=String(r.alerts_24h??0),s.kpiCritical24h.textContent=String(r.critical_alerts_24h??0),s.kpiAvgSpread.textContent=N(i,2),s.kpiTotalDepth.textContent=`$${N(m,0)}`}function ot(t,n,r){const e=j(n),c=Number(r);return t==="ok"?e===null?"状态正常":e<=2?"刚刚更新":`${e}s 前更新`:t==="stale"?Number.isFinite(c)&&c>=0?`数据 ${c}s 未更新`:"数据陈旧":e!==null?`上次成功 ${e}s 前`:"暂无成功样本"}function st(t){const r=(t.venues||[]).map(e=>{const c=e?.ratios?.depth_vs_baseline;return`
    <tr>
      <td>
        <strong>${l((e.venue||"-").toUpperCase())}</strong>
        <p class="tiny">${l(e.symbol||"-")}</p>
      </td>
      <td>
        <span class="status-tag status-${l(e.status||"down")}">
          ${l(e.status||"down")}
        </span>
        <p class="tiny">${l(ot(e.status,e.last_success_ts_utc||e.snapshot_ts_utc,e.snapshot_age_seconds))}</p>
        ${e.error_reason&&e.status!=="ok"?`<p class="tiny">${l(e.error_reason)}</p>`:""}
      </td>
      <td>${l(N(e.last_price,6))}</td>
      <td class="${l(O(e.pct_change_1h))}">${l(z(e.pct_change_1h))}</td>
      <td>$${l(N(e.quote_volume_24h,0))}</td>
      <td>${l(N(e.spread_bps,2))}</td>
      <td>$${l(N(e.depth_1pct_total_usdt,0))}</td>
      <td>${l(N(e.slip_bps_n2,2))}</td>
      <td class="${l(M(e.funding_rate))}">${l(D(e.funding_rate))}</td>
      <td>$${l(N(e.open_interest_usd,0))}</td>
      <td>
        <span class="${l(U(c))}">
          ${l(c==null?"-":`${Number(c).toFixed(2)}x`)}
        </span>
      </td>
    </tr>`}).join("");s.venueTbody.innerHTML=r||'<tr><td colspan="11">暂无数据</td></tr>'}function rt(t){const n=t?.items||[];if(s.alertCount.textContent=`最近 ${n.length} 条`,n.length===0){s.alertEmpty.classList.remove("hidden"),s.alertList.classList.add("hidden"),s.alertList.innerHTML="";return}s.alertEmpty.classList.add("hidden"),s.alertList.classList.remove("hidden"),s.alertList.innerHTML=n.map(r=>`
    <li class="alert-item">
      <div>
        <span class="severity-tag sev-${l(r.severity||"info")}">${l(r.severity||"info")}</span>
        <strong>${l(r.alert_type||"-")}</strong>
        <span class="muted">${l((r.venue||"-").toUpperCase())}</span>
      </div>
      <p>${l(r.message||"-")}</p>
      <p class="tiny">${l(K(r.ts_utc))}</p>
    </li>`).join("")}function lt(t){const n=t?.by_venue||{};if(Object.keys(n).length===0){s.trendSummary&&(s.trendSummary.textContent="暂无趋势数据"),L(t);return}s.trendSummary&&(s.trendSummary.textContent=""),L(t)}function at(t){s.tokenName.textContent=t.token_hint||"TOKEN",s.dbPath.textContent=t.db_path||"-",s.updatedAt.textContent=K(t.updated_at_utc),et(t.collector),nt(t),st(t)}function F(t,n,r){if(s.tokenSwitcher){if(!t||t.length<=1){s.tokenSwitcher.classList.add("hidden");return}s.tokenSwitcher.classList.remove("hidden"),s.tokenSwitcher.innerHTML=t.map(e=>`
    <button class="token-pill${e===n?" active":""}" data-token="${l(e)}">
      ${l(e)}
    </button>`).join(""),r&&s.tokenSwitcher.querySelectorAll(".token-pill").forEach(e=>{e.addEventListener("click",()=>r(e.dataset.token))})}}const Y=15e3;let g=!1,X=Y,V=Date.now()+Y,G=null,W="MON",H=[];function J(t){t!==W&&(W=t,F(H,W,J),!g&&(g=!0,k(!0),G.postMessage({type:"setToken",token:t})))}function ct(){const t=new URL("data:text/javascript;base64,bGV0IEJBU0UgPSAiIjsKbGV0IGF1dGhIZWFkZXJzID0ge307CmxldCBjdXJyZW50VG9rZW4gPSAiTU9OIjsKCmZ1bmN0aW9uIGluaXRDb25maWcodXJsLCBrZXkpIHsKICBCQVNFID0gYCR7dXJsfS9mdW5jdGlvbnMvdjFgOwogIGF1dGhIZWFkZXJzID0gewogICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke2tleX1gLAogICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICB9Owp9Cgphc3luYyBmdW5jdGlvbiBmZXRjaEpzb24ocGF0aCwgdGltZW91dE1zID0gMTIwMDApIHsKICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogIGNvbnN0IHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiBjb250cm9sbGVyLmFib3J0KCksIHRpbWVvdXRNcyk7CiAgdHJ5IHsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGAke0JBU0V9JHtwYXRofWAsIHsKICAgICAgaGVhZGVyczogYXV0aEhlYWRlcnMsCiAgICAgIGNhY2hlOiAibm8tc3RvcmUiLAogICAgICBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsLAogICAgfSk7CiAgICBpZiAoIXJlcy5vaykgdGhyb3cgbmV3IEVycm9yKGDor7fmsYLlpLHotKUgJHtyZXMuc3RhdHVzfTogJHtwYXRofWApOwogICAgcmV0dXJuIGF3YWl0IHJlcy5qc29uKCk7CiAgfSBmaW5hbGx5IHsKICAgIGNsZWFyVGltZW91dCh0aW1lcik7CiAgfQp9Cgphc3luYyBmdW5jdGlvbiBmZXRjaERhdGEoKSB7CiAgc2VsZi5wb3N0TWVzc2FnZSh7IHR5cGU6ICJzdGF0dXMiLCBzdGF0dXM6ICJmZXRjaGluZyIgfSk7CgogIGNvbnN0IHRva2VuUSA9IGB0b2tlbj0ke2VuY29kZVVSSUNvbXBvbmVudChjdXJyZW50VG9rZW4pfWA7CiAgY29uc3QgW292ZXJ2aWV3LCBoaXN0b3J5LCBhbGVydHNdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgZmV0Y2hKc29uKGAvYXBpLW92ZXJ2aWV3PyR7dG9rZW5RfWApLAogICAgZmV0Y2hKc29uKGAvYXBpLWhpc3Rvcnk/bGltaXQ9MTIwJiR7dG9rZW5RfWApLAogICAgZmV0Y2hKc29uKCIvYXBpLWFsZXJ0cz9saW1pdD01MCIpLAogIF0pOwoKICBzZWxmLnBvc3RNZXNzYWdlKHsgdHlwZTogImRhdGEiLCBvdmVydmlldywgaGlzdG9yeSwgYWxlcnRzIH0pOwp9Cgphc3luYyBmdW5jdGlvbiBmZXRjaFRva2VuTGlzdCgpIHsKICB0cnkgewogICAgY29uc3QgZGF0YSA9IGF3YWl0IGZldGNoSnNvbigiL2FwaS1hZG1pbi90b2tlbnMiKTsKICAgIGNvbnN0IHRva2VucyA9IChkYXRhLnRva2VucyB8fCBbXSkuZmlsdGVyKCh0KSA9PiB0LmVuYWJsZWQpLm1hcCgodCkgPT4gdC50b2tlbik7CiAgICBzZWxmLnBvc3RNZXNzYWdlKHsgdHlwZTogInRva2VucyIsIHRva2VucyB9KTsKICB9IGNhdGNoIHsKICAgIHNlbGYucG9zdE1lc3NhZ2UoeyB0eXBlOiAidG9rZW5zIiwgdG9rZW5zOiBbY3VycmVudFRva2VuXSB9KTsKICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIHJ1bkZldGNoKCkgewogIHRyeSB7CiAgICBhd2FpdCBmZXRjaERhdGEoKTsKICB9IGNhdGNoIChlcnIpIHsKICAgIHNlbGYucG9zdE1lc3NhZ2UoeyB0eXBlOiAiZXJyb3IiLCBtZXNzYWdlOiBlcnI/Lm1lc3NhZ2UgfHwgU3RyaW5nKGVycikgfSk7CiAgfQp9Cgphc3luYyBmdW5jdGlvbiBydW5Db2xsZWN0KCkgewogIHNlbGYucG9zdE1lc3NhZ2UoeyB0eXBlOiAic3RhdHVzIiwgc3RhdHVzOiAiY29sbGVjdGluZyIgfSk7CgogIHRyeSB7CiAgICBhd2FpdCBmZXRjaEpzb24oIi9jb2xsZWN0LW1vbiIpOwogICAgYXdhaXQgZmV0Y2hEYXRhKCk7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICBzZWxmLnBvc3RNZXNzYWdlKHsgdHlwZTogImVycm9yIiwgbWVzc2FnZTogZXJyPy5tZXNzYWdlIHx8IFN0cmluZyhlcnIpIH0pOwogIH0KfQoKc2VsZi5vbm1lc3NhZ2UgPSAoZSkgPT4gewogIGNvbnN0IHsgdHlwZSwgc3VwYWJhc2VVcmwsIGFub25LZXksIHRva2VuIH0gPSBlLmRhdGE7CgogIGlmICh0eXBlID09PSAiaW5pdCIpIHsKICAgIGluaXRDb25maWcoc3VwYWJhc2VVcmwsIGFub25LZXkpOwogICAgZmV0Y2hUb2tlbkxpc3QoKTsKICAgIHJ1bkZldGNoKCk7CiAgICByZXR1cm47CiAgfQoKICBpZiAodHlwZSA9PT0gInNldFRva2VuIikgewogICAgY3VycmVudFRva2VuID0gdG9rZW47CiAgICBydW5GZXRjaCgpOwogICAgcmV0dXJuOwogIH0KCiAgaWYgKHR5cGUgPT09ICJmZXRjaCIpIHsKICAgIHJ1bkZldGNoKCk7CiAgICByZXR1cm47CiAgfQoKICBpZiAodHlwZSA9PT0gImNvbGxlY3QiKSB7CiAgICBydW5Db2xsZWN0KCk7CiAgICByZXR1cm47CiAgfQp9Owo=",import.meta.url);G=new Worker(t,{type:"module"}),G.onmessage=n=>{const r=n.data;if(r.type==="tokens"){H=r.tokens,F(H,W,J);return}if(r.type==="status"){r.status==="collecting"?S("采集中...","status-loading"):r.status==="fetching"&&S("读取数据中...","status-loading");return}if(r.type==="data"){at(r.overview),lt(r.history),rt(r.alerts),E(""),V=Date.now()+X;const e=new Date().toLocaleTimeString("zh-CN",{hour12:!1});S(`采集完成 ${e}`,"status-success"),g=!1,k(!1);return}if(r.type==="error"){E(r.message),S("采集失败","status-error"),V=Date.now()+X,g=!1,k(!1);return}},G.onerror=n=>{E(n.message||"Worker 错误"),S("Worker 错误","status-error"),g=!1,k(!1)}}function it(){g||(g=!0,k(!0),G.postMessage({type:"fetch"}))}function T(){g||(g=!0,k(!0),G.postMessage({type:"collect"}))}function dt(){const t=tt();ct(),t.refreshBtn.addEventListener("click",it),t.collectBtn&&t.collectBtn.addEventListener("click",T),V=Date.now()+X,S("启动中...","status-loading"),g=!0,k(!0),G.postMessage({type:"init",supabaseUrl:"https://joisixcdkdihqduxllzn.supabase.co",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpvaXNpeGNka2RpaHFkdXhsbHpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODM2NjYsImV4cCI6MjA4NzA1OTY2Nn0.3v-G_lTJOnex0am3BLMgGA97_ZZ3tg9j8tXdDsN2H-U"}),setInterval(()=>{!g&&Date.now()>=V&&T()},1e3)}dt();
